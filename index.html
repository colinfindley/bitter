<!DOCTYPE html>
<html>
  <head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
    <title>Melody Rating</title>
	
	<script src="jspsych-6.0.2/jspsych.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/jquery-3.3.1.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

	
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-audio-keyboard-response.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-audio-button-response.js"></script>
    <script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-html-keyboard-response.js"></script>
    <script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-html-button-response.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-html-slider-response.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-fullscreen.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-external-html.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-survey-text.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-survey-multi-choice.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-free-sort.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-call-function.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-dropdown.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-survey-multi-select.js"></script>
	<script type="text/javascript" src="jspsych-6.0.2/plugins/jspsych-survey-likert.js"></script>
	<script type="text/javascript" src=""></script>
	




	<!-- Include base CSS (optional) -->

<!-- Include Choices CSS -->
<link rel="stylesheet" href="public/assets/styles/choices.min.css" />
<!-- Include Choices JavaScript -->
<script src="/public/assets/scripts/choices.min.js"></script>


    <link href="jspsych-6.0.2/css/jspsych.css" rel="stylesheet" type="text/css" />

  </head>
  <body></body>
  <script>


/**************/
/** TIMELINE **/
/**************/

var timeline = [];
 

/*************/
/** CONSENT **/
/*************/

//function to make sure consent box is clicked before proceeding
var check_consent = function(elem) {
  if ($('#consent_checkbox').is(':checked')) {
    return true;
  }
  else {
    alert("If you wish to participate, you must check the box next to the statement 'I agree to take part in this study.'");
    return false;
  }
  return false;
};
//CONSENT TRIAL
var consent_trial = {
  type:"external-html",
  url: "consent/consent.html", 
  cont_btn: "start",
  check_fn: check_consent
};	  
/*define subject ID and add it to data output*/	  

var identifier = Math.random().toString(36).substring(7);
jsPsych.data.addProperties({rand_id: identifier});
/*define welcome message trial */
	  var welcome = {
		  type: "html-keyboard-response",
		  stimulus: "Welcome to the study. Press any key to begin."
	  };

/**************************/
/** VOLUME AND HEADPHONE **/
/**************************/

//instructions	

var volume_check_inst1 = {
      type: 'html-keyboard-response',
      stimulus: "<p>Before we begin the main task, you will complete a short volume calibration and headphone check.</p><p>" +
	  "Please make sure you are in a quiet listening environment, that you are wearing headphones, and that your computer's volume is turned on.<p></p>" +
	  "<p></p>(Press SPACEBAR to continue)",
	  choices: [' '],
	  post_trial_gap: 250
    };
	
var volume_check_inst2 = {
      type: 'html-keyboard-response',
      stimulus: "<p>The volume calibration will be first.</p><p>" +
	  "You will hear a thirty-second noise. Please adjust your computer's volume so that this noise is being presented at a comfortable level.<p></p>" +
	  "<p></p>(Press SPACEBAR to listen)",
	  choices: [' '],
	  post_trial_gap: 250
    };
// volume level screen - 30-second brown noise should be adjusted to a comfortable level by participants
var volume_check = {	
	type: 'audio-button-response',
	stimulus: 'audCalib/volumetest.mp3',
    choices: ['I am ready to continue.'],
    prompt: "<p>Adjust your volume so that the noise is being played at a comfortable level.</p>"+
	"<p></p>Press the button whenever you are ready to continue.",
    response_ends_trial: true,
	trial_duration: 30000
	};
// push to experiment timeline
var volume_adjust = {timeline:[volume_check_inst1, volume_check_inst2, volume_check]};
// short test to check whether participants are wearing headphones headphone check 
var headphone_check_inst = {
	type: 'html-keyboard-response',
      stimulus: "<p>You will now complete a short headphone check.</p><p>" +
	  "On each trial, you will hear three tones. One of these tones will be quieter than the others. Your task is to identify whether the quiet tone occurred first, second, or third.</p><p>" + 
	  "There are six trials in total.<p></p>" +
	  "<p></p>(Press SPACEBAR to begin)",
	  choices: [' '],
	  post_trial_gap: 250
    };
var headphone_proc = {
    timeline: [
        {
            type: 'html-keyboard-response',
            stimulus: '<div style="font-size:60px;">+</div>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 500
        },
        {
            type: 'audio-button-response',
            stimulus: jsPsych.timelineVariable('headphone_stim'),
            prompt: "<p>Which tone was the quietest?</p>",
            choices: ['first', 'second', 'third'],
			data: { correctRESP: jsPsych.timelineVariable('correctRESP') },
            on_finish: function(data){
    if(data.button_pressed == data.correctRESP){
      data.correct = 1;
    } else {
      data.correct = 0;
    }
	jsPsych.data.addDataToLastTrial({
		designation: "headphone-test"
		});	
  }
       },
	   
{
  type: 'html-keyboard-response',
  trial_duration: 500,
  stimulus: function(){
    var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
    if(last_trial_correct){
      return "<p>Correct</p>";
    } else {
      return "<p>Incorrect</p>";
    }
  }
}	   
    ],
    timeline_variables: [
        { headphone_stim: 'audCalib/t1_1.mp3', correctRESP: 0 },
		{ headphone_stim: 'audCalib/t1_2.mp3', correctRESP: 0 },
		{ headphone_stim: 'audCalib/t2_1.mp3', correctRESP: 1 },
		{ headphone_stim: 'audCalib/t2_2.mp3', correctRESP: 1 },
		{ headphone_stim: 'audCalib/t3_1.mp3', correctRESP: 2 },
		{ headphone_stim: 'audCalib/t3_2.mp3', correctRESP: 2 }
    ],
	randomize_order: true
};
// push the headphone check to experiment timeline
var headphone_check = {timeline: [headphone_check_inst, headphone_proc]};
/*********************************/
/** MAIN VARIABLE RANDOMIZATION **/
/*********************************/  

/*randomly assign tempo/melody combination, append to data*/

var tempo_lists = ['40', '80', '120'];
var melody_lists = ['melody_01', 'melody_02', 'melody_03', 'melody_04', 'melody_05', 'melody_06', 'melody_07'];
var selected_tempo = jsPsych.randomization.shuffle(tempo_lists)[0]; //this is the selected tempo
var selected_melody = jsPsych.randomization.shuffle(melody_lists)[0]; //this is the selected melody
jsPsych.data.addProperties({tempo: selected_tempo, melody: selected_melody}); //add the properties to the data output
var folder = selected_tempo + '/' + selected_melody + '/'; //this is the folder that contains the sound files
/*define audio and preload files */

var audio_files = ['b01.mp3', 'b02.mp3', 'b03.mp3', 'b04.mp3', 'b05.mp3', 'b06.mp3', 'b07.mp3', 'b08.mp3', 'b09.mp3', 'b10.mp3', 'b11.mp3', 'b12.mp3', 'b13.mp3', 'b14.mp3'];
var filePaths = [];
var numFiles = audio_files.length;
      
for (i = 0; i < numFiles; i += 1) {
     filePaths.push(folder + (audio_files[i]));
   }
   
/*add the remaining audio files to filePaths for preloading*/

filePaths.push('audCalib/attnchk.mp3', 'audCalib/t1_1.mp3', 'audCalib/t1_2.mp3', 'audCalib/t2_1.mp3', 'audCalib/t2_2.mp3', 'audCalib/t3_1.mp3', 'audCalib/t3_2.mp3', 'audCalib/volumetest.mp3');
		
//these are the terms that participants will be rating the melodies on
var terms = ['bittersweet','sorrowful','joyful','carefree'];
var shuffledTerms;
var tindex;	
	
/************************/
/** TIMELINE VARIABLES **/
/************************/
		
/* define sound arrays for the trials*/		

var initial_trial = [
	{melody: filePaths[0], type: 'base-melody'},
	];
var harmonized_trials = [
	{melody: filePaths[1], type: '100-minor'},
	{melody: filePaths[2], type: 'minor-7th'},
	{melody: filePaths[3], type: '75-minor'},
	{melody: filePaths[4], type: '50-minor'},
	{melody: filePaths[5], type: '75-major'},
	{melody: filePaths[6], type: '100-major'},
	{melody: filePaths[7], type: 'major-7th'},
	{melody: filePaths[8], type: 'ton-min-1'},
	{melody: filePaths[9], type: 'ton-min-2'},
	{melody: filePaths[10], type: 'ton-min-3'},
	{melody: filePaths[11], type: 'ton-maj-1'},
	{melody: filePaths[12], type: 'ton-maj-2'},
	{melody: filePaths[13], type: 'ton-maj-3'}
	];
/************************/
/** MAIN TRIAL SCREENS **/
/************************/

/*instructions*/
	  var instructions_01 = {
  		type: "html-button-response",
  		stimulus: "<p><b>Music judgment task</b></p><p>Imagine that a music composer has come to you for feedback.</br>The composer just wrote a new, short melody and wants to know what kinds of feelings it conveys to you.</p>" +
				  "<p>Your job is to listen to the melody. After the melody is over, you will be asked to rate the melody on a few adjectives.</br>You will also be asked how much you like the melody.</p>" +
				  "<p>When you are ready to listen to the melody, press the button labeled 'Begin'</p>",
		  choices: ['Begin'],
		  post_trial_gap: 250
						};
						

/*instructions two*/
	  var instructions_02 = {
  		type: "html-button-response",
  		stimulus: "<p>Thank you for your responses.</p><p>Now, imagine that the composer is testing out different versions of the melody you just heard.</p>" +
				  "<p>Your job is to listen to these different versions of the melody. You will be asked to rate each melody on a few adjectives.</br>You will also be asked how much you like each melody.</br>There are 13 versions in total.</p>" +
				  "<p>When you are ready to listen to the different versions of the melody, press the button labeled 'Begin'</p>",
		  choices: ['Begin'],
		  post_trial_gap: 250
						};

/* define the music presentation trial */	

var play_melody = {
	type: "audio-keyboard-response",
	stimulus: jsPsych.timelineVariable('melody'),
	choices: jsPsych.NO_KEYS,
	trial_ends_after_audio: true,
	data: {harmony: jsPsych.timelineVariable('type')},
	on_start: function(){
		shuffledTerms = jsPsych.randomization.shuffle(terms);
		tindex = 0;
	}
       };
// Define Rating Trials 
var rating_screen = {
	type: "html-slider-response",
	stimulus: function(){return '<div style="width:500px;"><p>To what extent was the melody:</p><p style="font-size:30px;"><b>'+shuffledTerms[tindex]+'</b></p></div>';},
	labels: ['not at all', 'slightly', 'moderately', 'extremely'],
	response_ends_trial: true, 
	slider_width: 500,
	data: {harmony: jsPsych.timelineVariable('type')},
	on_finish: function(data){
		jsPsych.data.addDataToLastTrial({
              term: shuffledTerms[tindex]
            });
		tindex +=1;
		}
	};
/* define liking trial separately (always comes at the end of the procedure */

var liking = {
	type: "html-slider-response",
	stimulus: '<div style="width:500px;"><p>How much did you <em>like</em> this melody?</p></div>',
	labels: ['not at all', 'slightly', 'moderately', 'extremely'],
	response_ends_trial: true,
	slider_width: 500,
	data: {term: 'liking', harmony: jsPsych.timelineVariable('type')}
				};
	
		
/**************************/
/** DEFINE THE PROCEDURES**/
/**************************/


var procedure_base_melody = {
		timeline: [play_melody, rating_screen, rating_screen, rating_screen, rating_screen, liking],
		timeline_variables: initial_trial
	 };
				
var procedure_harmonies = {
		timeline: [play_melody, rating_screen, rating_screen, rating_screen, rating_screen, liking],
		timeline_variables: harmonized_trials,
		randomize_order:true
	};
/****************************/
/** SHORT ATTENTION CHECKS **/
/****************************/

var audchk = {
	type: 'audio-keyboard-response',
	stimulus: 'audCalib/attnchk.mp3',
	choices: [' '],
	trial_duration: 8000,
	response_ends_trial: true,
	on_finish: function(data){
		if (data.rt == null) {
			var audCheck = 0;
		} else {
			var audCheck = 1;
		}
	jsPsych.data.addDataToLastTrial({
			  AUD_PASS: audCheck
            });	
	}
}
var vischk = {
	type: 'survey-multi-choice',
	questions: [{prompt: "For data quality purposes, please select 'happy' from the choices below.", options: ['sad', 'happy', 'calm', 'angry']}],
	on_finish: function(data){
		var visattn = JSON.parse(jsPsych.data.get().last(1).values()[0].responses).Q0; 
		if (visattn == 'happy') {
		var visCheck = 1
		} else {
		var visCheck = 0
		}
		
		jsPsych.data.addDataToLastTrial({
			  VIS_PASS: visCheck
            });	
	}
}
/*************************/
/** SHORT QUESTIONNAIRE **/
/*************************/


// Questionaire Scales

var scale_education = ['No schooling', 'Elementary school (incomplete)', 'Elementary school', 'High school (incomplete)', "High school", "Undergraduate degree (incomplete)", "Undergraduate degree", "Master's degree", "Professional/Doctoral degree"];
var scale_gender = [" A woman", " A man", " Non-binary", "You do not have an option that describes me."]; //gender options
var scale_ethnicity = ['White', 'Hispanic origin', 'Black or African American', 'Native American', 'Native Hawaiian or Other Pacific Islander', 'Asian', 'Other'];
var genre = ['Rap/Hip Hop', 'Classical', 'Metal', 'Jazz', 'Electronic Dance Music', 'Pop', 'Other' ]
var scale_1 = [
  "Never", 
  "Infrequently", 
  "Somewhat frequently", 
  "Frequently",  
  "Very frequently"
];

/* "Never", 
  "Less Frequently (Once every few months)", 
  "Somewhat frequently (Once every few weeks)", 
  "Frequently (Every week)  ",  
  "Very frequently (Everyday)"
*/

//Start of survey 

var interim = {
  type: "html-keyboard-response",
  stimulus: "<p>Thank you for your responses.</br>You will now answer some basic demographic and musical background questions.</p><p>Press any key to continue.</p>"
};

/*demographic (age, gender)*/
/*var qD = {
  type: 'survey-text',
  questions: [{prompt: "How old are you? <br><em>(in years)</em>", rows:1, columns: 20, value:''}],
  preamble: ['<b> Please answer the following questions to the best of your ability.</b>'],
  
}; */

var questionnaire_gender = {
type: 'survey-multi-choice',
preamble: [''],
questions: [{prompt: "In terms of gender, I identify as...", options: scale_gender}],
on_finish: function(data){
	GENDER = JSON.parse(jsPsych.data.get().last(1).values()[0].responses).Q0; 
	if (GENDER == "You do not have an option that describes me.") {
		gender_clarify = 1;
	} else {
		gender_clarify = 0;
	}	
  }
};

var questionnaire_gender_followup = {
  type: 'survey-text',
  questions: [{prompt: "Please briefly describe your gender identity if you wish."}],
  preamble: ['']
};


var if_gender_clarify_node = {
    timeline: [questionnaire_gender_followup],
    conditional_function: function(){
        if(gender_clarify == 1){
            return true;
        } else {
            return false;
        }
    }
};






var qR = {
	type: 'survey-multi-select',
	questions: [
	{
		prompt: "Please specify your ethnicity" , 
		options: scale_ethnicity,
		required: true,
		name: 'ethnicity'
	}],
	
	
	
	preamble: ['<b> Please answer the following questions to the best of your ability.</b>'],
	

};

var qSES = {
	type: 'survey-multi-choice',
	questions: [
	{
		prompt: "What is your highest level of education received?" , 
		options: scale_education}],
};

var qIO = {
	type: 'survey-text',
  	questions: [{prompt: "How old are you? <br><em>(in years)</em>", rows:1, columns: 10, value:''},{prompt: "What is your occupation? <br>", rows:1, columns: 60, value:''}, {prompt: "What is your yearly income?<br><em>(in U.S. dollars)</em>", rows:1, columns: 30, value:''} ],
}; 




/*musician*/
var qM = {
	type: 'survey-multi-choice',
	questions: [{prompt: '<br>Have you ever played a musical instrument, including vocal training?', options: [' Yes', ' No']}, {prompt: 'Do you consider yourself a musician?', options: [' Yes', ' No']}],
	preamble: ['<b> Please answer the following musical background questions to the best of your ability.</b>'],
};

var qM2 = {
  type: 'survey-text',
  questions: [//{prompt: '<br>Have you ever played a musical instrument, including vocal training? (Y/N)', rows:1, columns: 5, value:''}, 
  			  {prompt: 'How many years have you played your instrument? <br>  <em> (if multiple, choose the time that has passed since you learned your first instrument)</em>', columns: 2},
			  //{prompt: 'Do you consider yourself a musician? (Y/N)',rows:1, columns: 5, value:''},
			  {prompt: 'How many hours a day do you spend listening to music?', columns: 2}
			  
			  ],
  preamble: ['<b>Please answer the following questions to the best of your ability.</b>'],
 // check_fn: check_answered
};

/*genres*/




var likert_page = {
  type: 'survey-likert',
  scale_width: 10000,
  questions: [
    {prompt: "Rap/Hip Hop.", name: 'rap', labels: scale_1},
    {prompt: 'Classical', name: 'classical', labels: scale_1},
    {prompt: 'Metal', name: 'metal', labels: scale_1},
    {prompt: 'Jazz', name: 'jazz', labels: scale_1},
	{prompt: 'Pop', name: 'pop', labels: scale_1},
	{prompt: 'Electronic Dance Music', name: 'edm', labels: scale_1},
	{prompt: 'Other', name: 'Other_genre', labels: scale_1}

  ],
  preamble: ['<b><div style = "padding: 30px;"> Please estimate the frequency that you listen to the following genres.</b>'],
  randomize_question_order: true
  
};



/*exemplar recordings for each category*/
var qE = {
  type: 'survey-text',
  questions: [{prompt: 'Joyful', rows:1, columns: 60, value:''}, 
			  {prompt: 'Sorrowful', rows:1, columns: 60, value:''},
			  {prompt: 'Carefree', rows:1, columns: 60, value:''}, 
			  {prompt: 'Bittersweet', rows:1, columns: 60, value:''}
			  ],
  preamble: ['<p>In this study, you assessed the extent to which each melody was <em>joyful</em>, <em>sorrowful</em>, <em>carefree</em>, and <em>bittersweet</em>.</br>' +
'Using the space provided below, list a single piece of music (outside of this study) that you most strongly associate with each term.</p>' +
'<p>Please try to be as specific as possible (providing artist/composer and/or song title, if possible).</p>'] 
};

var sorting_stimuli = [];
for (var i = 1; i <= 20; i++) {
    sorting_stimuli.push("img/cell_img_" + i + ".jpg");
}

var sort_trial = {
    type: 'free-sort',
    stimuli: sorting_stimuli,
    prompt: "<p><b><div style = 'text-align: center; font-size: large'>Please use your mouse to drag all of these terms into the given space, using the proximity <br> or distance between terms to indicate how closely they are related.</b></p>",
	sort_area_height: 600,
	stim_height: 40,
	stim_height: 40

};

var thankyou = {
	type: 'html-keyboard-response',
	choices: jsPsych.NO_KEYS,
	stimulus: 'Thank you for completing the task!'
}

/************************/
/** FINAL LANDING PAGE **/
/************************/

/*reference ID for mturk */ 

var idcode = {
  type: "html-keyboard-response",
  choices: jsPsych.NO_KEYS,
  stimulus: '<p>Thank you for participating. Here is your unique code.</p><p></p>' +
  '<p>' + identifier + '</p>' +
  '<p>Please copy this code exactly as it appears. This is what you must enter in MTurk to receive payment.' +
  '<p>Once you have entered the code in MTurk, you may exit out of this tab.</p>'
};
/*************************************/
/** Push Everything to the Timeline **/
/*************************************/


timeline.push(consent_trial);
timeline.push(welcome);
timeline.push(volume_adjust);
timeline.push(headphone_check);
timeline.push(instructions_01);
timeline.push(procedure_base_melody);
timeline.push(instructions_02);

timeline.push(procedure_harmonies);

timeline.push(audchk);

timeline.push(interim);
//Demographic Questions

timeline.push(sort_trial);

timeline.push(qR);
timeline.push(qSES)
timeline.push(qIO)
timeline.push(questionnaire_gender)
timeline.push(if_gender_clarify_node)
//Music Background
timeline.push(qM);
timeline.push(qM2);
timeline.push(likert_page);
// Songs that fit emotional keywords
timeline.push(qE);
//Checks and mturk code
timeline.push(vischk);
timeline.push(idcode);
/*********************/
/** INITIALIZE EXPT **/
/*********************/

 jsPsych.init ({
	timeline: timeline,
	 preload_audio: filePaths
});

	  </script>
	  
</html>